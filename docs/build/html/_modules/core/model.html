

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>core.model &mdash; SNN toolbox 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="SNN toolbox 0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> SNN toolbox
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configure_toolbox.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests.html">Tests</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">SNN toolbox</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>core.model</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for core.model</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu May 19 16:03:06 2016</span>

<span class="sd">Class for neural networks that have been converted from analog to spiking.</span>

<span class="sd">@author: rbodo</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># For compatibility with python2</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">future</span> <span class="kn">import</span> <span class="n">standard_library</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">snntoolbox.config</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>


<div class="viewcode-block" id="SNN"><a class="viewcode-back" href="../../core.html#core.model.SNN">[docs]</a><span class="k">class</span> <span class="nc">SNN</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent a neural network.</span>

<span class="sd">    Instances of this class contains all essential information about a network,</span>
<span class="sd">    independently of the model library in which the original network was built</span>
<span class="sd">    (e.g. Keras). This makes the SNN toolbox stable against changes in input</span>
<span class="sd">    formats. Another advantage is extensibility: In order to add a new input</span>
<span class="sd">    language to the toolbox (e.g. Caffe), a developer only needs to add a</span>
<span class="sd">    single module to ``model_libs`` package, implementing a number of methods</span>
<span class="sd">    (see the respective functions in &#39;keras_input_lib.py&#39; for more details.)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    path: string, optional</span>
<span class="sd">        Path to directory where to load model from. Defaults to</span>
<span class="sd">        ``settings[&#39;path&#39;]``.</span>

<span class="sd">    filename: string, optional</span>
<span class="sd">        Name of file to load model from. Defaults to ``settings[&#39;filename&#39;]``.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    model: Model</span>
<span class="sd">        A model instance of the network in the respective ``model_lib``.</span>

<span class="sd">    val_fn: Theano function</span>
<span class="sd">        A Theano function that allows evaluating the original model.</span>

<span class="sd">    input_shape: list</span>
<span class="sd">        The dimensions of the input sample:</span>
<span class="sd">        [batch_size, n_chnls, n_rows, n_cols]. For instance, mnist would have</span>
<span class="sd">        input shape [Null, 1, 28, 28].</span>

<span class="sd">    layers: list</span>
<span class="sd">        List of all the layers of the network, where each layer contains a</span>
<span class="sd">        dictionary with keys</span>

<span class="sd">        - layer_num (int): Index of layer.</span>
<span class="sd">        - layer_type (string): Describing the type, e.g. `Dense`,</span>
<span class="sd">          `Convolution`, `Pool`.</span>
<span class="sd">        - output_shape (list): The output dimensions of the layer.</span>

<span class="sd">        In addition, `Dense` and `Convolution` layer types contain</span>

<span class="sd">        - parameters (array): The weights and biases connecting this layer with</span>
<span class="sd">          the previous.</span>

<span class="sd">        `Convolution` layers contain further</span>

<span class="sd">        - nb_col (int): The x-dimension of filters.</span>
<span class="sd">        - nb_row (int): The y-dimension of filters.</span>
<span class="sd">        - border_mode (string): How to handle borders during convolution, e.g.</span>
<span class="sd">          `full`, `valid`, `same`.</span>

<span class="sd">        `Pooling` layers contain</span>

<span class="sd">        - pool_size (list): Specifies the subsampling factor in each dimension.</span>
<span class="sd">        - strides (list): The stepsize in each dimension during pooling.</span>

<span class="sd">        `Activation` layers (including Pooling) contain</span>

<span class="sd">        - get_activ: A Theano function computing the activations of a layer.</span>

<span class="sd">    labels: list</span>
<span class="sd">        The layer labels.</span>

<span class="sd">    layer_idx_map: list</span>
<span class="sd">        A list mapping the layer indices of the original network to the parsed</span>
<span class="sd">        network. (Not all layers of the original model are needed in the parsed</span>
<span class="sd">        model.) For instance: To get the layer index i of the original input</span>
<span class="sd">        ``model`` that corresponds to layer j of the parsed network ``layers``,</span>
<span class="sd">        one would use ``i = layer_idx_map[j]``.</span>

<span class="sd">    compiled_snn: SNN_compiled</span>
<span class="sd">        Object containing the compiled spiking network (ready for simulation).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>

        <span class="c1"># Import utility functions of input model library (&#39;model_lib&#39;) and</span>
        <span class="c1"># of the simulator to use (&#39;target_sim&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_modules</span><span class="p">()</span>

        <span class="c1"># Load input model structure and parameters.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_lib</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_fn</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;val_fn&#39;</span><span class="p">]</span>

        <span class="c1"># Parse input model to our common format, extracting all necessary</span>
        <span class="c1"># information about layers.</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_lib</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_idx_map</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;layer_idx_map&#39;</span><span class="p">]</span>

        <span class="c1"># Allocate an object which will contain the compiled spiking network</span>
        <span class="c1"># (ready for simulation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_snn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_sim</span><span class="o">.</span><span class="n">SNN_compiled</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>

<div class="viewcode-block" id="SNN.import_modules"><a class="viewcode-back" href="../../core.html#core.model.SNN.import_modules">[docs]</a>    <span class="k">def</span> <span class="nf">import_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import utility functions of input model library (&#39;model_lib&#39;) and of</span>
<span class="sd">        the simulator to use (&#39;target_sim&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_lib</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;snntoolbox.model_libs.&#39;</span> <span class="o">+</span>
                                       <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;model_lib&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_input_lib&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_sim</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;snntoolbox.target_simulators.&#39;</span> <span class="o">+</span>
                                        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;simulator&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_target_sim&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SNN.evaluate_ann"><a class="viewcode-back" href="../../core.html#core.model.SNN.evaluate_ann">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_ann</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the performance of a network.</span>

<span class="sd">        Wrapper for the evaluation functions of specific input neural network</span>
<span class="sd">        libraries ``settings[&#39;model_lib&#39;]`` like keras, caffe, torch, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        X_test : float32 array</span>
<span class="sd">            The input samples to test.</span>
<span class="sd">            With data of the form (channels, num_rows, num_cols),</span>
<span class="sd">            X_test has dimension (num_samples, channels*num_rows*num_cols)</span>
<span class="sd">            for a multi-layer perceptron, and</span>
<span class="sd">            (num_samples, channels, num_rows, num_cols) for a convolutional</span>
<span class="sd">            net.</span>
<span class="sd">        Y_test : float32 array</span>
<span class="sd">            Ground truth of test data. Has dimesion (num_samples, num_classes).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        The output of the ``model_lib`` specific evaluation function, e.g. the</span>
<span class="sd">        score of a Keras model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_lib</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_fn</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Test score: {:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Test accuracy: {:.2%}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">score</span></div>

<div class="viewcode-block" id="SNN.normalize_parameters"><a class="viewcode-back" href="../../core.html#core.model.SNN.normalize_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize the parameters of a network.</span>

<span class="sd">        The parameters of each layer are normalized with respect to the maximum</span>
<span class="sd">        activation or parameter value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        X_train : float32 array</span>
<span class="sd">            The input samples to use for determining the layer activations.</span>
<span class="sd">            With data of the form (channels, num_rows, num_cols),</span>
<span class="sd">            X_train has dimension (1, channels*num_rows*num_cols) for a</span>
<span class="sd">            multi-layer perceptron, and (1, channels, num_rows, num_cols) for a</span>
<span class="sd">            convnet.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">snntoolbox.io_utils.plotting</span> <span class="kn">import</span> <span class="n">plot_hist</span>
        <span class="kn">from</span> <span class="nn">snntoolbox.core.util</span> <span class="kn">import</span> <span class="n">get_activations_layer</span><span class="p">,</span> <span class="n">norm_parameters</span>
<span class="c1">#        import matplotlib.pyplot as plt</span>
<span class="c1">#        import numpy as np</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Normalizing parameters:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;log_dir_of_current_run&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;normalization&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">)</span>
        <span class="c1"># Loop through all layers, looking for layers with parameters</span>
        <span class="n">scale_fac</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
            <span class="c1"># Skip layer if not preceeded by a layer with parameters</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Calculating output of activation layer {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s2">&quot; following layer {} with shape {}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;output_shape&#39;</span><span class="p">]))</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
            <span class="c1"># Undo previous scaling before calculating activations:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_layer_params</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_fac</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                  <span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">activations</span> <span class="o">=</span> <span class="n">get_activations_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;get_activ&#39;</span><span class="p">],</span> <span class="n">X_train</span><span class="p">)</span>
<span class="c1">#            plt.figure()</span>
<span class="c1">#            plt.hist(np.max(</span>
<span class="c1">#                activations, axis=tuple(range(1, activations.ndim))),</span>
<span class="c1">#                bins=len(activations))</span>
<span class="c1">#            plt.title(&quot;Distribution of maximum activations \n in layer &quot; +</span>
<span class="c1">#                      &quot;{}&quot;.format(self.labels[idx-1]))</span>
<span class="c1">#            plt.xlabel(&quot;max activation&quot;)</span>
<span class="c1">#            plt.ylabel(&quot;sample count&quot;)</span>
<span class="c1">#            plt.show()</span>
<span class="c1">#            if &#39;Dense&#39; in self.labels[idx-1]:</span>
<span class="c1">#                plt.figure()</span>
<span class="c1">#                p = np.percentile(activations, settings[&#39;percentile&#39;])</span>
<span class="c1">#                plt.hist(np.nonzero(activations &gt;= p)[1],</span>
<span class="c1">#                         bins=activations.shape[1])</span>
<span class="c1">#                plt.title(&quot;Histogram of &#39;hot&#39; neurons\n&quot; +</span>
<span class="c1">#                          &quot;in  layer {}&quot;.format(self.labels[idx-1]))</span>
<span class="c1">#                plt.text(0.8, 0.8, &quot;percentile = {}\nscale = {:.2f}&quot;.format(</span>
<span class="c1">#                    settings[&#39;percentile&#39;], p))</span>
<span class="c1">#                plt.xlabel(&quot;Neuron index&quot;)</span>
<span class="c1">#                plt.ylabel(&quot;Sample count&quot;)</span>
<span class="c1">#                plt.show()</span>

            <span class="n">parameters_norm</span><span class="p">,</span> <span class="n">scale_fac</span> <span class="o">=</span> <span class="n">norm_parameters</span><span class="p">(</span>
                <span class="n">parameters</span><span class="p">,</span> <span class="n">activations</span><span class="p">,</span> <span class="n">scale_fac</span><span class="p">)</span>
            <span class="c1"># Update model with modified parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_layer_params</span><span class="p">(</span><span class="n">parameters_norm</span><span class="p">,</span> <span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Compute activations with modified parameters</span>
            <span class="n">activations_norm</span> <span class="o">=</span> <span class="n">get_activations_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;get_activ&#39;</span><span class="p">],</span>
                                                     <span class="n">X_train</span><span class="p">)</span>
            <span class="c1"># For memory reasons, use only a fraction of samples for plotting a</span>
            <span class="c1"># histogram of activations.</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">activations</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">activation_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Activations&#39;</span><span class="p">:</span> <span class="n">activations</span><span class="p">[:</span><span class="n">frac</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="s1">&#39;Activations_norm&#39;</span><span class="p">:</span> <span class="n">activations_norm</span><span class="p">[:</span><span class="n">frac</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()}</span>
            <span class="n">weight_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="s1">&#39;weights_norm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()}</span>
            <span class="n">plot_hist</span><span class="p">(</span><span class="n">activation_dict</span><span class="p">,</span> <span class="s1">&#39;Activation&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">newpath</span><span class="p">,</span> <span class="n">scale_fac</span><span class="p">)</span>
            <span class="n">plot_hist</span><span class="p">(</span><span class="n">weight_dict</span><span class="p">,</span> <span class="s1">&#39;Weight&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">newpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="SNN.set_layer_params"><a class="viewcode-back" href="../../core.html#core.model.SNN.set_layer_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_layer_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set ``parameters`` of layer ``i``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_lib</span><span class="o">.</span><span class="n">set_layer_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_idx_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="SNN.get_params"><a class="viewcode-back" href="../../core.html#core.model.SNN.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list where each entry contains the parameters of a layer of the</span>
<span class="sd">        model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span>
                <span class="k">if</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

<div class="viewcode-block" id="SNN.save"><a class="viewcode-back" href="../../core.html#core.model.SNN.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write model architecture and parameters to disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path: string, optional</span>
<span class="sd">            Path to directory where to save model. Defaults to</span>
<span class="sd">            ``settings[&#39;path&#39;]``.</span>

<span class="sd">        filename: string, optional</span>
<span class="sd">            Name of file to write model to. Defaults to</span>
<span class="sd">            ``settings[&#39;filename_snn&#39;]``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">snntoolbox.io_utils.save</span> <span class="kn">import</span> <span class="n">confirm_overwrite</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;filename_snn&#39;</span><span class="p">]</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Saving parsed model to {}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="c1"># Create directory if not existent yet.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">confirm_overwrite</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_parameters</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">confirm_overwrite</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Done.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SNN.get_config"><a class="viewcode-back" href="../../core.html#core.model.SNN.get_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary describing the model.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># When adding a parser for a new input model format, you may need to</span>
        <span class="c1"># supplement the following list by non-JSON-serializable objects.</span>
        <span class="n">skip_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;get_activ&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;model_protobuf&#39;</span><span class="p">]</span>
        <span class="n">layer_config</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">layer_config</span><span class="o">.</span><span class="n">append</span><span class="p">([{</span><span class="n">key</span><span class="p">:</span> <span class="n">layer</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_keys</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">,</span>
                <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="n">layer_config</span><span class="p">}</span></div>

<div class="viewcode-block" id="SNN.save_config"><a class="viewcode-back" href="../../core.html#core.model.SNN.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save model configuration to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">snntoolbox.io_utils.save</span> <span class="kn">import</span> <span class="n">to_json</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>

        <span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SNN.save_parameters"><a class="viewcode-back" href="../../core.html#core.model.SNN.save_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">save_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump all layer parameters to a HDF5 file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">h5py</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;layer_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
            <span class="n">param_values</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_values</span><span class="p">)):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;param_&#39;</span> <span class="o">+</span> <span class="n">idx</span>
                <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;param_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_names</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">param_values</span><span class="p">):</span>
                <span class="n">param_dset</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">val</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">param_dset</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SNN.build"><a class="viewcode-back" href="../../core.html#core.model.SNN.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_snn</span><span class="o">.</span><span class="n">build</span><span class="p">()</span></div>

<div class="viewcode-block" id="SNN.run"><a class="viewcode-back" href="../../core.html#core.model.SNN.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_snn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span></div>

<div class="viewcode-block" id="SNN.export_to_sim"><a class="viewcode-back" href="../../core.html#core.model.SNN.export_to_sim">[docs]</a>    <span class="k">def</span> <span class="nf">export_to_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;filename_snn_exported&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_snn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="SNN.end_sim"><a class="viewcode-back" href="../../core.html#core.model.SNN.end_sim">[docs]</a>    <span class="k">def</span> <span class="nf">end_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_snn</span><span class="o">.</span><span class="n">end_sim</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Bodo Rueckauer.
      Last updated on Aug 08, 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>